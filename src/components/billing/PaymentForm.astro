---
import Layout from '../../layouts/Layout.astro';
import { getPaymentManager } from '../../lib/payments';

const paymentManager = getPaymentManager();
const clientConfig = paymentManager.getClientConfig();
const paymentMethods = await paymentManager.getPaymentMethods();
---

<Layout title="Payment - Maskom Network">
  <div class="max-w-4xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h1 class="text-2xl font-bold mb-6">Complete Your Payment</h1>

      <form id="payment-form" class="space-y-6">
        <!-- Order Summary -->
        <div class="border rounded-lg p-4 bg-gray-50">
          <h2 class="text-lg font-semibold mb-3">Order Summary</h2>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span>Internet Service Package</span>
              <span id="package-amount">Rp 500.000</span>
            </div>
            <div class="flex justify-between">
              <span>Tax (11%)</span>
              <span id="tax-amount">Rp 55.000</span>
            </div>
            <div class="border-t pt-2 flex justify-between font-bold">
              <span>Total</span>
              <span id="total-amount">Rp 555.000</span>
            </div>
          </div>
        </div>

        <!-- Customer Information -->
        <div class="border rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">Customer Information</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                First Name *
              </label>
              <input
                type="text"
                name="firstName"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Last Name *
              </label>
              <input
                type="text"
                name="lastName"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Email *
              </label>
              <input
                type="email"
                name="email"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Phone *
              </label>
              <input
                type="tel"
                name="phone"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>
        </div>

        <!-- Payment Method Selection -->
        <div class="border rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">Payment Method</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            {
              paymentMethods.map(method => (
                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                  <input
                    type="radio"
                    name="paymentMethod"
                    value={method.id}
                    class="mr-3"
                    required
                  />
                  <span class="font-medium">{method.name}</span>
                </label>
              ))
            }
          </div>
        </div>

        <!-- Credit Card Details (shown only when credit card is selected) -->
        <div id="credit-card-details" class="border rounded-lg p-4 hidden">
          <h2 class="text-lg font-semibold mb-3">Credit Card Information</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Card Number *
              </label>
              <div class="relative">
                <input
                  type="text"
                  id="card-number"
                  maxlength="16"
                  class="w-full px-3 py-2 pr-12 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="1234 5678 9012 3456"
                />
                <div
                  id="card-type"
                  class="absolute right-3 top-2.5 text-sm text-gray-500"
                >
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Expiry Date *
                </label>
                <input
                  type="text"
                  id="card-expiry"
                  maxlength="5"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="MM/YY"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  CVV *
                </label>
                <input
                  type="text"
                  id="card-cvv"
                  maxlength="4"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="123"
                />
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Cardholder Name *
              </label>
              <input
                type="text"
                id="cardholder-name"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="John Doe"
              />
            </div>
          </div>
        </div>

        <!-- Billing Address -->
        <div class="border rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">Billing Address</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Address *
              </label>
              <input
                type="text"
                name="address"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                City *
              </label>
              <input
                type="text"
                name="city"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Postal Code *
              </label>
              <input
                type="text"
                name="postalCode"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>
        </div>

        <!-- Terms and Conditions -->
        <div class="flex items-center">
          <input type="checkbox" id="terms" required class="mr-2" />
          <label for="terms" class="text-sm text-gray-700">
            I agree to the <a
              href="/terms"
              class="text-blue-600 hover:underline">Terms and Conditions</a
            >
            and <a href="/privacy" class="text-blue-600 hover:underline"
              >Privacy Policy</a
            >
          </label>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end">
          <button
            type="submit"
            id="pay-button"
            class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Process Payment
          </button>
        </div>
      </form>
    </div>

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <div class="flex items-center justify-center mb-4">
          <div
            class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"
          >
          </div>
        </div>
        <p class="text-center text-gray-700">Processing your payment...</p>
      </div>
    </div>
  </div>

  <!-- Midtrans Snap Script -->
  <script
    src="https://app.sandbox.midtrans.com/snap/snap.js"
    data-client-key={clientConfig.clientKey}></script>

  <script>
    // Payment form handling
    const paymentForm = document.getElementById('payment-form');
    const payButton = document.getElementById('pay-button');
    const loadingOverlay = document.getElementById('loading-overlay');
    const creditCardDetails = document.getElementById('credit-card-details');
    const paymentMethodRadios = document.querySelectorAll(
      'input[name="paymentMethod"]'
    );

    // Show/hide credit card details based on payment method
    paymentMethodRadios.forEach(radio => {
      radio.addEventListener('change', e => {
        if (e.target.value === 'credit_card') {
          creditCardDetails.classList.remove('hidden');
        } else {
          creditCardDetails.classList.add('hidden');
        }
      });
    });

    // Format card number
    const cardNumberInput = document.getElementById('card-number');
    const cardTypeDiv = document.getElementById('card-type');

    cardNumberInput?.addEventListener('input', e => {
      let value = e.target.value.replace(/\s/g, '');
      let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
      e.target.value = formattedValue;

      // Detect card type
      if (value.startsWith('4')) {
        cardTypeDiv.textContent = 'Visa';
      } else if (value.startsWith('5')) {
        cardTypeDiv.textContent = 'Mastercard';
      } else if (value.startsWith('3')) {
        cardTypeDiv.textContent = 'Amex';
      } else {
        cardTypeDiv.textContent = '';
      }
    });

    // Format expiry date
    const cardExpiryInput = document.getElementById('card-expiry');
    cardExpiryInput?.addEventListener('input', e => {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2, 4);
      }
      e.target.value = value;
    });

    // CVV validation
    const cardCvvInput = document.getElementById('card-cvv');
    cardCvvInput?.addEventListener('input', e => {
      e.target.value = e.target.value.replace(/\D/g, '');
    });

    // Form submission
    paymentForm?.addEventListener('submit', async e => {
      e.preventDefault();

      const formData = new FormData(paymentForm);
      const paymentMethod = formData.get('paymentMethod');

      // Validate credit card details if selected
      if (paymentMethod === 'credit_card') {
        const cardNumber = document
          .getElementById('card-number')
          .value.replace(/\s/g, '');
        const cardExpiry = document.getElementById('card-expiry').value;
        const cardCvv = document.getElementById('card-cvv').value;
        const cardholderName = document.getElementById('cardholder-name').value;

        if (!cardNumber || cardNumber.length < 13 || cardNumber.length > 16) {
          alert('Please enter a valid card number');
          return;
        }

        if (!cardExpiry || !cardExpiry.match(/^\d{2}\/\d{2}$/)) {
          alert('Please enter a valid expiry date (MM/YY)');
          return;
        }

        if (!cardCvv || cardCvv.length < 3 || cardCvv.length > 4) {
          alert('Please enter a valid CVV');
          return;
        }

        if (!cardholderName) {
          alert('Please enter the cardholder name');
          return;
        }
      }

      try {
        loadingOverlay.classList.remove('hidden');
        payButton.disabled = true;

        const orderData = {
          orderId: 'ORDER-' + Date.now(),
          amount: 555000,
          customerDetails: {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            billingAddress: {
              firstName: formData.get('firstName'),
              lastName: formData.get('lastName'),
              address: formData.get('address'),
              city: formData.get('city'),
              postalCode: formData.get('postalCode'),
              phone: formData.get('phone'),
              countryCode: 'ID',
            },
          },
          itemDetails: [
            {
              id: 'PKG-001',
              price: 500000,
              quantity: 1,
              name: 'Internet Service Package',
              category: 'Internet Service',
            },
            {
              id: 'TAX-001',
              price: 55000,
              quantity: 1,
              name: 'Tax (11%)',
              category: 'Tax',
            },
          ],
          paymentMethod: paymentMethod,
        };

        const response = await fetch('/api/payments/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(orderData),
        });

        const result = await response.json();

        if (result.success) {
          if (result.paymentResponse.token) {
            // Use Midtrans Snap for payment
            window.snap.pay(result.paymentResponse.token, {
              onSuccess: function (result) {
                window.location.href =
                  '/payment/success?order_id=' + result.order_id;
              },
              onPending: function (result) {
                window.location.href =
                  '/payment/pending?order_id=' + result.order_id;
              },
              onError: function (result) {
                window.location.href =
                  '/payment/error?order_id=' + result.order_id;
              },
              onClose: function () {
                loadingOverlay.classList.add('hidden');
                payButton.disabled = false;
              },
            });
          } else if (result.paymentResponse.redirectUrl) {
            // Redirect to payment page
            window.location.href = result.paymentResponse.redirectUrl;
          } else {
            throw new Error('No payment token or redirect URL received');
          }
        } else {
          throw new Error(result.error || 'Payment processing failed');
        }
      } catch (error) {
        console.error('Payment error:', error);
        alert('Payment processing failed: ' + error.message);
        loadingOverlay.classList.add('hidden');
        payButton.disabled = false;
      }
    });
  </script>
</Layout>
