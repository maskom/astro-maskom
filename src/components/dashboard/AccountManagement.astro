---
// Account Management Component
import { supabase } from '../../lib/supabase.ts';

// Get user session and profile data
const user = await supabase.auth.getUser();
let customerProfile = null;
let serviceAddresses = [];

if (user.data.user) {
  try {
    // Get customer profile
    const { data: profile } = await supabase
      .from('customer_profiles')
      .select('*')
      .eq('user_id', user.data.user.id)
      .single();

    customerProfile = profile;

    // Get service addresses
    const { data: addresses } = await supabase
      .from('service_addresses')
      .select('*')
      .eq('user_id', user.data.user.id)
      .order('is_primary', { ascending: false });

    serviceAddresses = addresses || [];
  } catch (error) {
    console.error('Error fetching account data:', {
      error: error instanceof Error ? error.message : String(error),
      timestamp: new Date().toISOString(),
      action: 'fetchAccountData',
    });
  }
}
---

<div class="bg-white rounded-lg shadow-lg p-6">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-semibold text-gray-900">Account Management</h2>
    <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">
      Edit Profile
    </button>
  </div>

  <!-- Profile Information -->
  <div class="space-y-4">
    <div class="flex items-center space-x-4">
      <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center">
        {customerProfile?.profile_image_url ? (
          <img 
            src={customerProfile.profile_image_url} 
            alt="Profile" 
            class="w-16 h-16 rounded-full object-cover"
          />
        ) : (
          <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
          </svg>
        )}
      </div>
      <div>
        <h3 class="text-lg font-medium text-gray-900">
          {customerProfile ? `${customerProfile.first_name} ${customerProfile.last_name}` : 'Guest User'}
        </h3>
        <p class="text-sm text-gray-500">{user.data.user?.email}</p>
      </div>
    </div>

    <!-- Contact Information -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t">
      <div>
        <p class="text-sm font-medium text-gray-700">Phone</p>
        <p class="text-sm text-gray-900">
          {customerProfile?.phone || 'Not provided'}
        </p>
      </div>
      <div>
        <p class="text-sm font-medium text-gray-700">Date of Birth</p>
        <p class="text-sm text-gray-900">
          {customerProfile?.date_of_birth 
            ? new Date(customerProfile.date_of_birth).toLocaleDateString('id-ID')
            : 'Not provided'
          }
        </p>
      </div>
    </div>

    <!-- Service Addresses -->
    <div class="pt-4 border-t">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-sm font-medium text-gray-700">Service Addresses</h4>
        <button class="text-blue-600 hover:text-blue-800 text-sm">
          Add Address
        </button>
      </div>
      
      {serviceAddresses.length > 0 ? (
        <div class="space-y-2">
          {serviceAddresses.map(address => (
            <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
              <svg class="w-5 h-5 text-gray-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
              </svg>
              <div class="flex-1">
                <p class="text-sm text-gray-900">
                  {address.address_line1}
                  {address.address_line2 && `, ${address.address_line2}`}
                </p>
                <p class="text-sm text-gray-500">
                  {address.city}, {address.province} {address.postal_code}
                </p>
                {address.is_primary && (
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mt-1">
                    Primary
                  </span>
                )}
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-4">
          <svg class="mx-auto h-8 w-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
          </svg>
          <p class="mt-2 text-sm text-gray-500">No service addresses added</p>
          <button class="mt-2 text-blue-600 hover:text-blue-800 text-sm font-medium">
            Add Your First Address
          </button>
        </div>
      )}
    </div>

    <!-- Quick Actions -->
    <div class="pt-4 border-t">
      <h4 class="text-sm font-medium text-gray-700 mb-3">Quick Actions</h4>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button class="flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
          <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 2 2 0 012 2 1 1 0 102 0 4 4 0 00-4-4z" clip-rule="evenodd" />
          </svg>
          Change Password
        </button>
        <button class="flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
          <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 016 0v2h2V7a5 5 0 00-5-5z" />
          </svg>
          Security Settings
        </button>
      </div>
    </div>
  </div>
</div>