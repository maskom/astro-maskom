---
// Support Integration Component
import { supabase } from '../../lib/supabase.ts';

// Get user session and support data
const user = await supabase.auth.getUser();
let supportTickets = [];
let serviceRequests = [];

if (user.data.user) {
  try {
    // Get support tickets
    const { data: tickets } = await supabase
      .from('support_tickets')
      .select('*')
      .eq('user_id', user.data.user.id)
      .order('updated_at', { ascending: false })
      .limit(5);

    supportTickets = tickets || [];

    // Get service requests
    const { data: requests } = await supabase
      .from('service_requests')
      .select('*')
      .eq('user_id', user.data.user.id)
      .order('updated_at', { ascending: false })
      .limit(3);

    serviceRequests = requests || [];
  } catch (error) {
    console.error('Error fetching support data:', error);
  }
}

// Get status color
function getStatusColor(status) {
  switch (status) {
    case 'open':
    case 'pending':
      return 'bg-yellow-100 text-yellow-800';
    case 'in_progress':
    case 'scheduled':
      return 'bg-blue-100 text-blue-800';
    case 'resolved':
    case 'completed':
      return 'bg-green-100 text-green-800';
    case 'closed':
    case 'cancelled':
      return 'bg-gray-100 text-gray-800';
    default:
      return 'bg-gray-100 text-gray-800';
  }
}

// Get priority color
function getPriorityColor(priority) {
  switch (priority) {
    case 'urgent':
      return 'bg-red-100 text-red-800';
    case 'high':
      return 'bg-orange-100 text-orange-800';
    case 'medium':
      return 'bg-yellow-100 text-yellow-800';
    case 'low':
      return 'bg-gray-100 text-gray-800';
    default:
      return 'bg-gray-100 text-gray-800';
  }
}
---

<div class="bg-white rounded-lg shadow-lg p-6">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-semibold text-gray-900">Support & Service</h2>
    <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">
      View All
    </button>
  </div>

  <!-- Quick Actions -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6">
    <button class="flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
      <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
      </svg>
      Create Ticket
    </button>
    <button class="flex items-center justify-center px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
      <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
      </svg>
      Contact Support
    </button>
  </div>

  <!-- Recent Support Tickets -->
  <div class="mb-6">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-medium text-gray-700">Recent Support Tickets</h3>
      {supportTickets.length > 0 && (
        <a href="/support/tickets" class="text-blue-600 hover:text-blue-800 text-sm">
          View All
        </a>
      )}
    </div>
    
    {supportTickets.length > 0 ? (
      <div class="space-y-2">
        {supportTickets.map(ticket => (
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer">
            <div class="flex-1">
              <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-900">{ticket.ticket_number}</span>
                <span class={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${getStatusColor(ticket.status)}`}>
                  {ticket.status.replace('_', ' ')}
                </span>
                {ticket.priority !== 'medium' && (
                  <span class={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${getPriorityColor(ticket.priority)}`}>
                    {ticket.priority}
                  </span>
                )}
              </div>
              <p class="text-sm text-gray-900 mt-1">{ticket.subject}</p>
              <p class="text-xs text-gray-500 mt-1">
                Updated {new Date(ticket.updated_at).toLocaleDateString('id-ID')}
              </p>
            </div>
            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
            </svg>
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-4">
        <svg class="mx-auto h-8 w-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
        </svg>
        <p class="mt-2 text-sm text-gray-500">No support tickets yet</p>
        <p class="text-xs text-gray-400">Create a ticket to get help with any issues</p>
      </div>
    )}
  </div>

  <!-- Service Requests -->
  <div class="mb-6">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-medium text-gray-700">Service Requests</h3>
      {serviceRequests.length > 0 && (
        <a href="/support/requests" class="text-blue-600 hover:text-blue-800 text-sm">
          View All
        </a>
      )}
    </div>
    
    {serviceRequests.length > 0 ? (
      <div class="space-y-2">
        {serviceRequests.map(request => (
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer">
            <div class="flex-1">
              <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-900 capitalize">
                  {request.request_type.replace('_', ' ')}
                </span>
                <span class={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${getStatusColor(request.status)}`}>
                  {request.status.replace('_', ' ')}
                </span>
              </div>
              <p class="text-sm text-gray-900 mt-1">{request.title}</p>
              {request.preferred_date && (
                <p class="text-xs text-gray-500 mt-1">
                  Preferred: {new Date(request.preferred_date).toLocaleDateString('id-ID')}
                  {request.preferred_time_window && ` (${request.preferred_time_window})`}
                </p>
              )}
            </div>
            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
            </svg>
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-4">
        <svg class="mx-auto h-8 w-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
        </svg>
        <p class="mt-2 text-sm text-gray-500">No service requests</p>
        <p class="text-xs text-gray-400">Schedule installation, moving, or repairs</p>
      </div>
    )}
  </div>

  <!-- Knowledge Base & Resources -->
  <div>
    <h3 class="text-sm font-medium text-gray-700 mb-3">Helpful Resources</h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <a href="/help/knowledge-base" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
        <svg class="w-5 h-5 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" />
        </svg>
        <div>
          <p class="text-sm font-medium text-gray-900">Knowledge Base</p>
          <p class="text-xs text-gray-500">Find answers to common questions</p>
        </div>
      </a>
      
      <a href="/help/guides" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
        <svg class="w-5 h-5 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
        </svg>
        <div>
          <p class="text-sm font-medium text-gray-900">User Guides</p>
          <p class="text-xs text-gray-500">Step-by-step tutorials</p>
        </div>
      </a>
      
      <a href="/help/faq" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
        <svg class="w-5 h-5 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
        </svg>
        <div>
          <p class="text-sm font-medium text-gray-900">FAQ</p>
          <p class="text-xs text-gray-500">Frequently asked questions</p>
        </div>
      </a>
      
      <a href="/status" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
        <svg class="w-5 h-5 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
        </svg>
        <div>
          <p class="text-sm font-medium text-gray-900">Service Status</p>
          <p class="text-xs text-gray-500">Check network status</p>
        </div>
      </a>
    </div>
  </div>
</div>