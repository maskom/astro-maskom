---
// Billing & Payment Component
import { supabase } from '../../lib/supabase.ts';

// Get user session and billing data
const user = await supabase.auth.getUser();
let currentBalance = 0;
let outstandingInvoices = [];
let recentTransactions = [];
let paymentMethods = [];

if (user.data.user) {
  try {
    // Get outstanding invoices
    const { data: invoices } = await supabase
      .from('invoices')
      .select('*')
      .eq('user_id', user.data.user.id)
      .in('status', ['sent', 'overdue'])
      .order('due_date', { ascending: true })
      .limit(5);

    outstandingInvoices = invoices || [];
    currentBalance = outstandingInvoices.reduce((sum, invoice) => sum + Number(invoice.total), 0);

    // Get recent transactions
    const { data: transactions } = await supabase
      .from('payment_transactions')
      .select('*')
      .eq('user_id', user.data.user.id)
      .order('created_at', { ascending: false })
      .limit(5);

    recentTransactions = transactions || [];

    // Get payment methods
    const { data: methods } = await supabase
      .from('payment_methods')
      .select('*')
      .eq('user_id', user.data.user.id)
      .eq('is_active', true)
      .order('created_at', { ascending: false });

    paymentMethods = methods || [];
  } catch (error) {
    console.error('Error fetching billing data:', {
      error: error instanceof Error ? error.message : String(error),
      timestamp: new Date().toISOString(),
      action: 'fetchBillingData',
    });
  }
}
---

<div class="bg-white rounded-lg shadow-lg p-6">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-semibold text-gray-900">Billing & Payments</h2>
    <div class="flex space-x-2">
      <a href="/billing" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
        View All
      </a>
      <a href="/billing/payment" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
        Make Payment
      </a>
    </div>
  </div>

  <!-- Current Balance -->
  <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg p-4 mb-6 text-white">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium opacity-90">Current Balance</p>
        <p class="text-2xl font-bold">
          Rp {currentBalance.toLocaleString('id-ID')}
        </p>
        {outstandingInvoices.length > 0 && (
          <p class="text-sm opacity-75 mt-1">
            {outstandingInvoices.length} outstanding invoice{outstandingInvoices.length > 1 ? 's' : ''}
          </p>
        )}
      </div>
      <div class="text-right">
        {outstandingInvoices.length > 0 && (
          <a href="/billing/payment" class="inline-flex items-center px-3 py-1.5 border border-white text-xs font-medium rounded-md text-white hover:bg-white hover:bg-opacity-10">
            Pay Now
          </a>
        )}
      </div>
    </div>
  </div>

  <!-- Outstanding Invoices -->
  {outstandingInvoices.length > 0 && (
    <div class="mb-6">
      <h3 class="text-sm font-medium text-gray-700 mb-3">Outstanding Invoices</h3>
      <div class="space-y-2">
        {outstandingInvoices.slice(0, 3).map(invoice => (
          <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-lg">
            <div>
              <p class="text-sm font-medium text-gray-900">{invoice.invoice_number}</p>
              <p class="text-xs text-gray-500">
                Due: {new Date(invoice.due_date).toLocaleDateString('id-ID')}
              </p>
            </div>
            <div class="text-right">
              <p class="text-sm font-semibold text-gray-900">
                Rp {Number(invoice.total).toLocaleString('id-ID')}
              </p>
              <span class={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                invoice.status === 'overdue' 
                  ? 'bg-red-100 text-red-800' 
                  : 'bg-yellow-100 text-yellow-800'
              }`}>
                {invoice.status}
              </span>
            </div>
          </div>
        ))}
      </div>
      {outstandingInvoices.length > 3 && (
        <p class="text-sm text-gray-500 mt-2 text-center">
          +{outstandingInvoices.length - 3} more invoices
        </p>
      )}
    </div>
  )}

  <!-- Recent Transactions -->
  <div class="mb-6">
    <h3 class="text-sm font-medium text-gray-700 mb-3">Recent Transactions</h3>
    {recentTransactions.length > 0 ? (
      <div class="space-y-2">
        {recentTransactions.map(transaction => (
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div>
              <p class="text-sm font-medium text-gray-900">{transaction.order_id}</p>
              <p class="text-xs text-gray-500">
                {new Date(transaction.created_at).toLocaleDateString('id-ID')}
              </p>
            </div>
            <div class="text-right">
              <p class="text-sm font-semibold text-gray-900">
                Rp {Number(transaction.amount).toLocaleString('id-ID')}
              </p>
              <span class={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                transaction.status === 'success' 
                  ? 'bg-green-100 text-green-800' 
                  : transaction.status === 'pending'
                    ? 'bg-yellow-100 text-yellow-800'
                    : 'bg-red-100 text-red-800'
              }`}>
                {transaction.status}
              </span>
            </div>
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-4">
        <svg class="mx-auto h-8 w-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" />
          <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd" />
        </svg>
        <p class="mt-2 text-sm text-gray-500">No recent transactions</p>
      </div>
    )}
  </div>

  <!-- Payment Methods -->
  <div>
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-medium text-gray-700">Payment Methods</h3>
<a href="/billing/methods" class="text-blue-600 hover:text-blue-800 text-sm">
          Add New
        </a>
    </div>
    {paymentMethods.length > 0 ? (
      <div class="space-y-2">
        {paymentMethods.slice(0, 2).map(method => (
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 bg-gray-200 rounded flex items-center justify-center">
                {method.type === 'credit_card' ? (
                  <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" />
                    <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd" />
                  </svg>
                ) : method.type === 'bank_transfer' ? (
                  <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
                  </svg>
                ) : (
                  <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                  </svg>
                )}
              </div>
              <div>
                <p class="text-sm font-medium text-gray-900">{method.display_name}</p>
                <p class="text-xs text-gray-500 capitalize">{method.type.replace('_', ' ')}</p>
              </div>
            </div>
            <button class="text-gray-400 hover:text-gray-600">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
              </svg>
            </button>
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-4">
        <svg class="mx-auto h-8 w-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" />
          <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd" />
        </svg>
        <p class="mt-2 text-sm text-gray-500">No payment methods saved</p>
        <a href="/billing/methods" class="mt-2 text-blue-600 hover:text-blue-800 text-sm font-medium">
          Add Payment Method
        </a>
      </div>
    )}
  </div>
</div>