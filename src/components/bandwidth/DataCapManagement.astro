---
interface DataCap {
  id: string;
  package_id: string;
  monthly_cap_gb: number;
  current_usage_gb: number;
  billing_cycle_start: string;
  notification_thresholds: number[];
  is_active: boolean;
}

interface DataCapManagementProps {
  dataCap: DataCap | null;
  availablePackages: Array<{
    id: string;
    name: string;
    description: string;
    price: string;
  }>;
}

const { dataCap, availablePackages } = Astro.props;

// Calculate usage percentage
function getUsagePercentage(): number {
  if (!dataCap) return 0;
  return Math.round((dataCap.current_usage_gb / dataCap.monthly_cap_gb) * 100);
}

// Get remaining data
function getRemainingGB(): number {
  if (!dataCap) return 0;
  return Math.max(0, dataCap.monthly_cap_gb - dataCap.current_usage_gb);
}

// Get days remaining in billing cycle
function getDaysRemaining(): number {
  if (!dataCap) return 0;
  const billingStart = new Date(dataCap.billing_cycle_start);
  const billingEnd = new Date(billingStart.getTime() + 30 * 24 * 60 * 60 * 1000);
  const now = new Date();
  const diffTime = billingEnd.getTime() - now.getTime();
  return Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
}

// Get package name by ID
function getPackageName(packageId: string): string {
  const pkg = availablePackages.find(p => p.id === packageId);
  return pkg ? pkg.name : packageId;
}

const usagePercentage = getUsagePercentage();
const remainingGB = getRemainingGB();
const daysRemaining = getDaysRemaining();
---

<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-semibold text-gray-800">Manajemen Kuota Data</h2>
    {dataCap && (
      <button 
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
        onclick="showUpgradeModal()"
      >
        Upgrade Paket
      </button>
    )}
  </div>

  {dataCap ? (
    <div class="space-y-6">
      <!-- Current Package Info -->
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-1">
              {getPackageName(dataCap.package_id)}
            </h3>
            <p class="text-sm text-gray-600">
              Kuota: {dataCap.monthly_cap_gb} GB/bulan
            </p>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold text-blue-600">
              {usagePercentage}%
            </div>
            <div class="text-xs text-gray-600">Terpakai</div>
          </div>
        </div>
      </div>

      <!-- Usage Details -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="text-sm text-gray-600 mb-1">Sisa Kuota</div>
          <div class="text-xl font-semibold text-gray-800">
            {remainingGB.toFixed(2)} GB
          </div>
          <div class="text-xs text-gray-500">
            {100 - usagePercentage}% tersisa
          </div>
        </div>
        
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="text-sm text-gray-600 mb-1">Sisa Waktu</div>
          <div class="text-xl font-semibold text-gray-800">
            {daysRemaining} hari
          </div>
          <div class="text-xs text-gray-500">
            Sampai siklus penagihan berikutnya
          </div>
        </div>
      </div>

      <!-- Notification Settings -->
      <div class="border-t pt-4">
        <h4 class="text-sm font-medium text-gray-700 mb-3">Pengaturan Notifikasi</h4>
        <div class="space-y-2">
          {dataCap.notification_thresholds.map((threshold) => (
            <div class="flex items-center justify-between py-2 px-3 bg-gray-50 rounded">
              <span class="text-sm text-gray-700">
                Notifikasi saat kuota mencapai {threshold}%
              </span>
              <span class={`px-2 py-1 text-xs rounded-full ${
                usagePercentage >= threshold 
                  ? 'bg-red-100 text-red-700' 
                  : 'bg-green-100 text-green-700'
              }`}>
                {usagePercentage >= threshold ? 'Aktif' : 'Menunggu'}
              </span>
            </div>
          ))}
        </div>
      </div>

      <!-- Usage Alerts -->
      {usagePercentage >= 80 && (
        <div class={`rounded-lg p-4 ${
          usagePercentage >= 90 
            ? 'bg-red-50 border border-red-200' 
            : 'bg-yellow-50 border border-yellow-200'
        }`}>
          <div class="flex items-center">
            <div class="text-2xl mr-3">
              {usagePercentage >= 90 ? '⚠️' : '⚡'}
            </div>
            <div>
              <h4 class={`font-medium ${
                usagePercentage >= 90 ? 'text-red-800' : 'text-yellow-800'
              }`}>
                {usagePercentage >= 90 ? 'Kuota Hampir Habis!' : 'Kuota Menipis'}
              </h4>
              <p className={`text-sm ${
                usagePercentage >= 90 ? 'text-red-600' : 'text-yellow-600'
              }`}>
                {usagePercentage >= 90 
                  ? `Sisa kuota Anda hanya ${remainingGB.toFixed(2)} GB. Segera lakukan pengisian ulang atau upgrade paket.`
                  : `Anda telah menggunakan ${usagePercentage}% kuota bulanan. Pertimbangkan penggunaan lebih hemat.`
                }
              </p>
            </div>
          </div>
        </div>
      )}
    </div>
  ) : (
    <div class="text-center py-8">
      <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
      </svg>
      <h3 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Paket Aktif</h3>
      <p class="text-gray-600 mb-4">Anda belum memiliki paket internet aktif. Pilih paket untuk mulai menggunakan layanan kami.</p>
      <button 
        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        onclick="showPackageSelection()"
      >
        Pilih Paket
      </button>
    </div>
  )}
</div>

<!-- Upgrade Modal (hidden by default) -->
<div id="upgradeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold mb-4">Upgrade Paket</h3>
    <p class="text-gray-600 mb-4">Pilih paket yang sesuai dengan kebutuhan Anda:</p>
    
    <div class="space-y-3 mb-6">
      {availablePackages.map((pkg) => (
        <div class="border rounded-lg p-3 hover:border-blue-500 cursor-pointer transition-colors" onclick="selectPackage('{pkg.id}')">
          <div class="flex justify-between items-start">
            <div>
              <h4 class="font-medium text-gray-800">{pkg.name}</h4>
              <p class="text-sm text-gray-600">{pkg.description}</p>
            </div>
            <div class="text-right">
              <div class="font-semibold text-blue-600">{pkg.price}</div>
            </div>
          </div>
        </div>
      ))}
    </div>
    
    <div class="flex space-x-3">
      <button 
        class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors"
        onclick="closeUpgradeModal()"
      >
        Batal
      </button>
      <button 
        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        onclick="confirmUpgrade()"
      >
        Konfirmasi
      </button>
    </div>
  </div>
</div>

<script>
  let selectedPackageId = null;

  function showUpgradeModal() {
    const modal = document.getElementById('upgradeModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function closeUpgradeModal() {
    const modal = document.getElementById('upgradeModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    selectedPackageId = null;
  }

  function selectPackage(packageId) {
    selectedPackageId = packageId;
    
    // Update UI to show selected package
    document.querySelectorAll('#upgradeModal .border').forEach(el => {
      el.classList.remove('border-blue-500', 'bg-blue-50');
    });
    
    event.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
  }

  async function confirmUpgrade() {
    if (!selectedPackageId) {
      alert('Silakan pilih paket terlebih dahulu');
      return;
    }

    try {
      const response = await fetch('/api/bandwidth/data-caps', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('supabase_token')}`
        },
        body: JSON.stringify({
          package_id: selectedPackageId,
          monthly_cap_gb: getPackageCap(selectedPackageId),
          billing_cycle_start: new Date().toISOString().split('T')[0]
        })
      });

      if (response.ok) {
        alert('Paket berhasil diupgrade! Halaman akan dimuat ulang.');
        window.location.reload();
      } else {
        const error = await response.json();
        alert('Gagal mengupgrade paket: ' + error.error);
      }
    } catch (error) {
      console.error('Error upgrading package:', error);
      alert('Terjadi kesalahan saat mengupgrade paket');
    }
  }

  function getPackageCap(packageId) {
    // This should match the package caps defined in your system
    const caps = {
      'home-a': 50,
      'home-b': 100,
      'home-c': 200,
      'soho-pro': 300,
      'soho-business': 500,
      'soho-enterprise': 1000,
      'corporate-business': 1000,
      'corporate-enterprise': 2000
    };
    return caps[packageId] || 100;
  }

  function showPackageSelection() {
    showUpgradeModal();
  }

// Ensure functions are available globally
  window.showUpgradeModal = showUpgradeModal;
  window.closeUpgradeModal = closeUpgradeModal;
  window.selectPackage = selectPackage;
  window.confirmUpgrade = confirmUpgrade;
  window.getPackageCap = getPackageCap;
  window.showPackageSelection = showPackageSelection;
</script>