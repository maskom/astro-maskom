---
interface PerformanceReport {
  id: string;
  report_type: string;
  report_period_start: string;
  report_period_end: string;
  status: string;
  overall_quality_score: number;
  reliability_score: number;
  speed_consistency_score: number;
  sla_compliance_percentage: number;
  created_at: string;
  generated_at: string;
  file_path?: string;
}

interface PerformanceReportsProps {
  userId: string;
}

const { userId } = Astro.props;

// Function to get report type label
function getReportTypeLabel(type: string): string {
  switch (type) {
    case 'monthly': return 'Bulanan';
    case 'quarterly': return 'Kuartalan';
    case 'sla_certificate': return 'Sertifikat SLA';
    case 'custom': return 'Kustom';
    default: return type;
  }
}

// Function to get status color
function getStatusColor(status: string): string {
  switch (status) {
    case 'generated': return 'bg-green-100 text-green-800';
    case 'generating': return 'bg-yellow-100 text-yellow-800';
    case 'failed': return 'bg-red-100 text-red-800';
    default: return 'bg-gray-100 text-gray-800';
  }
}

// Function to format date
function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString('id-ID', { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric' 
  });
}

// Function to get score color
function getScoreColor(score: number): string {
  if (score >= 90) return 'text-green-600';
  if (score >= 80) return 'text-yellow-600';
  if (score >= 70) return 'text-orange-600';
  return 'text-red-600';
}
---

<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-semibold text-gray-800">Laporan Performa</h2>
    <div class="flex items-center space-x-3">
      <button 
        id="generateReportBtn"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
        onclick="openReportModal()"
      >
        üìä Buat Laporan Baru
      </button>
      <button 
        class="text-sm text-blue-600 hover:text-blue-800"
        onclick="refreshReports()"
      >
        üîÑ Refresh
      </button>
    </div>
  </div>

  <!-- Reports List -->
  <div id="reportsList" class="space-y-4">
    <div class="text-center text-gray-500 py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <div class="text-sm">Memuat laporan performa...</div>
    </div>
  </div>
</div>

<!-- Generate Report Modal -->
<div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-gray-800">Buat Laporan Performa Baru</h3>
      <button 
        onclick="closeReportModal()"
        class="text-gray-500 hover:text-gray-700"
      >
        ‚úï
      </button>
    </div>

    <form id="reportForm" onsubmit="generateReport(event)">
      <!-- Report Type -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Jenis Laporan
        </label>
        <select 
          id="reportType"
          name="report_type"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          required
        >
          <option value="">Pilih jenis laporan</option>
          <option value="monthly">Laporan Bulanan</option>
          <option value="quarterly">Laporan Kuartalan</option>
          <option value="sla_certificate">Sertifikat SLA</option>
          <option value="custom">Laporan Kustom</option>
        </select>
      </div>

      <!-- Period Start -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Tanggal Mulai
        </label>
        <input 
          type="date"
          id="periodStart"
          name="report_period_start"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          required
        >
      </div>

      <!-- Period End -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Tanggal Selesai
        </label>
        <input 
          type="date"
          id="periodEnd"
          name="report_period_end"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          required
        >
      </div>

      <!-- Options -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Opsi Tambahan
        </label>
        <div class="space-y-2">
          <label class="flex items-center">
            <input 
              type="checkbox"
              name="include_sla_compliance"
              checked
              class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            >
            <span class="text-sm text-gray-700">Sertakan kepatuhan SLA</span>
          </label>
          <label class="flex items-center">
            <input 
              type="checkbox"
              name="include_benchmarks"
              checked
              class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            >
            <span class="text-sm text-gray-700">Sertakan benchmark performa</span>
          </label>
          <label class="flex items-center">
            <input 
              type="checkbox"
              name="include_recommendations"
              checked
              class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            >
            <span class="text-sm text-gray-700">Sertakan rekomendasi</span>
          </label>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex justify-end space-x-3">
        <button 
          type="button"
          onclick="closeReportModal()"
          class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors"
        >
          Batal
        </button>
        <button 
          type="submit"
          id="submitBtn"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          Buat Laporan
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 flex flex-col items-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
    <div class="text-gray-700">Membuat laporan...</div>
  </div>
</div>

<script>
  let authToken = '';
  let reports = [];

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    authToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
    if (authToken) {
      loadReports();
      setDefaultDates();
    }
  });

  // Load performance reports
  async function loadReports() {
    try {
      const response = await fetch('/api/quality/reports', {
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      });

      if (response.ok) {
        const data = await response.json();
        reports = data;
        updateReportsDisplay(data);
      } else {
        console.error('Failed to load reports');
        showError('Gagal memuat laporan performa');
      }
    } catch (error) {
      console.error('Error loading reports:', error);
      showError('Terjadi kesalahan saat memuat laporan');
    }
  }

  // Update reports display
  function updateReportsDisplay(data) {
    const reportsList = document.getElementById('reportsList');
    
    if (!data || data.length === 0) {
      reportsList.innerHTML = `
        <div class="text-center text-gray-500 py-8">
          <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p class="text-lg font-medium mb-2">Belum ada laporan performa</p>
          <p class="text-sm">Buat laporan pertama Anda untuk melihat analisis performa jaringan</p>
        </div>
      `;
      return;
    }

    reportsList.innerHTML = data.map(report => `
      <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center space-x-3 mb-2">
              <h3 class="text-lg font-medium text-gray-800">
                ${getReportTypeLabel(report.report_type)}
              </h3>
              <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusColor(report.status)}">
                ${report.status === 'generated' ? 'Selesai' : 
                  report.status === 'generating' ? 'Dibuat' : 'Gagal'}
              </span>
            </div>
            
            <div class="text-sm text-gray-600 mb-3">
              Periode: ${formatDate(report.report_period_start)} - ${formatDate(report.report_period_end)}
            </div>

            ${report.status === 'generated' ? `
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-3">
                <div>
                  <div class="text-xs text-gray-500">Skor Kualitas</div>
                  <div class="text-lg font-semibold ${getScoreColor(report.overall_quality_score)}">
                    ${report.overall_quality_score?.toFixed(1) || '-'}
                  </div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">Reliabilitas</div>
                  <div class="text-lg font-semibold ${getScoreColor(report.reliability_score)}">
                    ${report.reliability_score?.toFixed(1) || '-'}%
                  </div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">Konsistensi Kecepatan</div>
                  <div class="text-lg font-semibold ${getScoreColor(report.speed_consistency_score)}">
                    ${report.speed_consistency_score?.toFixed(1) || '-'}
                  </div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">Kepatuhan SLA</div>
                  <div class="text-lg font-semibold ${getScoreColor(report.sla_compliance_percentage)}">
                    ${report.sla_compliance_percentage?.toFixed(1) || '-'}%
                  </div>
                </div>
              </div>
            ` : ''}

            <div class="flex items-center justify-between">
              <div class="text-xs text-gray-500">
                Dibuat: ${new Date(report.created_at).toLocaleString('id-ID')}
                ${report.generated_at ? `‚Ä¢ Selesai: ${new Date(report.generated_at).toLocaleString('id-ID')}` : ''}
              </div>
              
              <div class="flex items-center space-x-2">
                ${report.status === 'generated' ? `
                  <button 
                    class="text-sm text-blue-600 hover:text-blue-800"
                    onclick="viewReport('${report.id}')"
                  >
                    üëÅÔ∏è Lihat
                  </button>
                  <button 
                    class="text-sm text-green-600 hover:text-green-800"
                    onclick="downloadReport('${report.id}')"
                  >
                    üì• Unduh
                  </button>
                ` : ''}
                <button 
                  class="text-sm text-red-600 hover:text-red-800"
                  onclick="deleteReport('${report.id}')"
                >
                  üóëÔ∏è Hapus
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }

  // Generate new report
  async function generateReport(event) {
    event.preventDefault();
    
    const loadingOverlay = document.getElementById('loadingOverlay');
    const submitBtn = document.getElementById('submitBtn');
    
    try {
      loadingOverlay.classList.remove('hidden');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Membuat...';

      const formData = new FormData(event.target);
      const reportData = {
        report_type: formData.get('report_type'),
        report_period_start: formData.get('report_period_start'),
        report_period_end: formData.get('report_period_end'),
        include_sla_compliance: formData.has('include_sla_compliance'),
        include_benchmarks: formData.has('include_benchmarks'),
        include_recommendations: formData.has('include_recommendations'),
      };

      const response = await fetch('/api/quality/reports', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${authToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(reportData)
      });

      if (response.ok) {
        const result = await response.json();
        closeReportModal();
        await loadReports();
        showSuccess('Laporan berhasil dibuat!');
      } else {
        const error = await response.json();
        throw new Error(error.error || 'Failed to generate report');
      }
    } catch (error) {
      console.error('Error generating report:', error);
      showError('Gagal membuat laporan: ' + error.message);
    } finally {
      loadingOverlay.classList.add('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Buat Laporan';
    }
  }

  // View report details
  async function viewReport(reportId) {
    try {
      const report = reports.find(r => r.id === reportId);
      if (!report) return;

      // In a real implementation, this would open a detailed view
      alert(`Detail laporan untuk ${getReportTypeLabel(report.report_type)}\\n\\n` +
            `Periode: ${formatDate(report.report_period_start)} - ${formatDate(report.report_period_end)}\\n` +
            `Skor Kualitas: ${report.overall_quality_score?.toFixed(1) || '-'}\\n` +
            `Reliabilitas: ${report.reliability_score?.toFixed(1) || '-'}%\\n` +
            `Konsistensi Kecepatan: ${report.speed_consistency_score?.toFixed(1) || '-'}\\n` +
            `Kepatuhan SLA: ${report.sla_compliance_percentage?.toFixed(1) || '-'}%`);
    } catch (error) {
      console.error('Error viewing report:', error);
      showError('Gagal melihat detail laporan');
    }
  }

  // Download report
  async function downloadReport(reportId) {
    try {
      const report = reports.find(r => r.id === reportId);
      if (!report || !report.file_path) {
        showError('File laporan tidak tersedia');
        return;
      }

      // In a real implementation, this would download the actual file
      showSuccess('Mengunduh laporan...');
      
      // Simulate download
      setTimeout(() => {
        const link = document.createElement('a');
        link.href = '#';
        link.download = `laporan-${report.report_type}-${new Date(report.report_period_start).toISOString().split('T')[0]}.pdf`;
        link.click();
      }, 1000);
    } catch (error) {
      console.error('Error downloading report:', error);
      showError('Gagal mengunduh laporan');
    }
  }

  // Delete report
  async function deleteReport(reportId) {
    if (!confirm('Apakah Anda yakin ingin menghapus laporan ini?')) {
      return;
    }

    try {
      // In a real implementation, this would call the delete API
      showSuccess('Laporan berhasil dihapus');
      await loadReports();
    } catch (error) {
      console.error('Error deleting report:', error);
      showError('Gagal menghapus laporan');
    }
  }

  // Refresh reports
  async function refreshReports() {
    await loadReports();
    showSuccess('Laporan diperbarui');
  }

  // Modal functions
  function openReportModal() {
    document.getElementById('reportModal').classList.remove('hidden');
  }

  function closeReportModal() {
    document.getElementById('reportModal').classList.add('hidden');
    document.getElementById('reportForm').reset();
    setDefaultDates();
  }

  // Set default dates (last month for monthly, last 3 months for quarterly)
  function setDefaultDates() {
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
    
    document.getElementById('periodStart').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('periodEnd').value = lastMonthEnd.toISOString().split('T')[0];
  }

  // Update dates when report type changes
  document.getElementById('reportType')?.addEventListener('change', function(e) {
    const today = new Date();
    let startDate, endDate;
    
    switch (e.target.value) {
      case 'monthly':
        startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        endDate = new Date(today.getFullYear(), today.getMonth(), 0);
        break;
      case 'quarterly':
        const currentQuarter = Math.floor(today.getMonth() / 3);
        const lastQuarter = currentQuarter === 0 ? 3 : currentQuarter - 1;
        const year = currentQuarter === 0 ? today.getFullYear() - 1 : today.getFullYear();
        startDate = new Date(year, lastQuarter * 3, 1);
        endDate = new Date(year, (lastQuarter + 1) * 3, 0);
        break;
      case 'sla_certificate':
        startDate = new Date(today.getFullYear(), 0, 1);
        endDate = new Date(today.getFullYear(), 11, 31);
        break;
      default:
        setDefaultDates();
        return;
    }
    
    document.getElementById('periodStart').value = startDate.toISOString().split('T')[0];
    document.getElementById('periodEnd').value = endDate.toISOString().split('T')[0];
  });

  // Utility functions
  function getReportTypeLabel(type) {
    switch (type) {
      case 'monthly': return 'Bulanan';
      case 'quarterly': return 'Kuartalan';
      case 'sla_certificate': return 'Sertifikat SLA';
      case 'custom': return 'Kustom';
      default: return type;
    }
  }

  function getStatusColor(status) {
    switch (status) {
      case 'generated': return 'bg-green-100 text-green-800';
      case 'generating': return 'bg-yellow-100 text-yellow-800';
      case 'failed': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('id-ID', { 
      day: 'numeric', 
      month: 'long', 
      year: 'numeric' 
    });
  }

  function getScoreColor(score) {
    if (score >= 90) return 'text-green-600';
    if (score >= 80) return 'text-yellow-600';
    if (score >= 70) return 'text-orange-600';
    return 'text-red-600';
  }

  function showSuccess(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  function showError(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Close modal when clicking outside
  document.getElementById('reportModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      closeReportModal();
    }
  });
</script>