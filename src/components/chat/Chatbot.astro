---
interface Message {
  role: 'user' | 'assistant';
  content: string;
}

interface ChatbotProps {
  initialMessages?: Message[];
}

const { initialMessages = [] } = Astro.props;
---

<div class="flex flex-col h-[500px] border border-gray-200 rounded-lg overflow-hidden" id="chatbot">
  <!-- Chat header -->
  <div class="bg-indigo-600 text-white p-4">
    <h2 class="text-lg font-semibold">Maskom Network Assistant</h2>
  </div>
  
  <!-- Messages container -->
  <div class="flex-1 overflow-y-auto p-4 bg-gray-50" id="messages-container">
    <div id="messages-list"></div>
    <div id="loading-indicator" class="hidden text-left mb-4">
      <div class="inline-block p-3 rounded-lg bg-white border border-gray-200 rounded-bl-none">
        <div class="flex space-x-2">
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
        </div>
      </div>
    </div>
    <div id="messages-end"></div>
  </div>
  
  <!-- Input area -->
  <div class="border-t border-gray-200 p-4 bg-white">
    <form id="chat-form" class="flex space-x-2">
      <input
        type="text"
        id="chat-input"
        placeholder="Type your message..."
        class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
      />
      <button
        type="submit"
        id="send-button"
        class="bg-indigo-600 text-white rounded-lg px-4 py-2 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50"
      >
        Send
      </button>
    </form>
  </div>
</div>

<script>
  const initialMessages = JSON.parse('{JSON.stringify(initialMessages)}');
  let messages = [...initialMessages];
  let loading = false;
  
  const messagesList = document.getElementById('messages-list');
  const chatInput = document.getElementById('chat-input') as HTMLInputElement;
  const chatForm = document.getElementById('chat-form');
  const sendButton = document.getElementById('send-button') as HTMLButtonElement;
  const loadingIndicator = document.getElementById('loading-indicator');
  
  const scrollToBottom = () => {
    const messagesEnd = document.getElementById('messages-end');
    if (messagesEnd) {
      messagesEnd.scrollIntoView({ behavior: "smooth" });
    }
  };
  
  const renderMessages = () => {
    if (messagesList) {
      messagesList.innerHTML = messages.map(message => `
      <div class="mb-4 ${message.role === 'user' ? 'text-right' : 'text-left'}">
        <div class="inline-block p-3 rounded-lg max-w-[80%] ${
          message.role === 'user' 
            ? 'bg-indigo-500 text-white rounded-br-none' 
            : 'bg-white border border-gray-200 rounded-bl-none'
        }">
          ${message.content}
        </div>
      </div>
    `).join('');
      scrollToBottom();
    }
  };
  
  const sendMessage = async () => {
    if (!chatInput) return;
    const input = chatInput.value.trim();
    if (!input || loading) return;
    
    const userMessage = { role: 'user', content: input };
    messages = [...messages, userMessage];
    chatInput.value = '';
    loading = true;
    if (sendButton) sendButton.disabled = true;
    if (loadingIndicator) loadingIndicator.classList.remove('hidden');
    renderMessages();
    
    try {
      const response = await fetch('/api/chat/completion', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: messages.slice(1) }),
      });
      
      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error);
      }
      
      const assistantMessage = { role: 'assistant', content: data.response };
      messages = [...messages, assistantMessage];
    } catch (error) {
      const errorMessage = { 
        role: 'assistant', 
        content: 'Sorry, I encountered an error. Please try again.' 
      };
      messages = [...messages, errorMessage];
    } finally {
      loading = false;
      if (sendButton) sendButton.disabled = false;
      if (loadingIndicator) loadingIndicator.classList.add('hidden');
      renderMessages();
    }
  };
  
  if (chatForm) {
    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      sendMessage();
    });
  }
  
  // Initial render
  renderMessages();
</script>