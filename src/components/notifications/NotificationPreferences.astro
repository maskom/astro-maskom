---
import type { CustomerNotificationPreferences } from '../../lib/notifications/outage-service';

interface NotificationPreferencesProps {
  preferences?: CustomerNotificationPreferences;
}

const { preferences } = Astro.props;
---

<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
  <h2 class="text-xl font-semibold text-gray-800 mb-6">Notification Preferences</h2>
  
  <form id="notification-preferences-form" class="space-y-6">
    <!-- Notification Channels -->
    <div>
      <h3 class="text-lg font-medium text-gray-700 mb-4">Notification Channels</h3>
      <div class="space-y-3">
        <label class="flex items-center">
          <input
            type="checkbox"
            name="email_notifications"
            checked={preferences?.email_notifications ?? true}
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
          />
          <span class="ml-2 text-gray-700">Email Notifications</span>
        </label>
        
        <label class="flex items-center">
          <input
            type="checkbox"
            name="sms_notifications"
            checked={preferences?.sms_notifications ?? false}
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
          />
          <span class="ml-2 text-gray-700">SMS Notifications</span>
        </label>
        
        <label class="flex items-center">
          <input
            type="checkbox"
            name="in_app_notifications"
            checked={preferences?.in_app_notifications ?? true}
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
          />
          <span class="ml-2 text-gray-700">In-App Notifications</span>
        </label>
        
        <label class="flex items-center">
          <input
            type="checkbox"
            name="push_notifications"
            checked={preferences?.push_notifications ?? false}
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
          />
          <span class="ml-2 text-gray-700">Push Notifications</span>
        </label>
      </div>
    </div>

    <!-- Phone Number (shown only if SMS is enabled) -->
    <div id="phone-number-field" class={`${preferences?.sms_notifications ? '' : 'hidden'}`}>
      <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-2">
        Phone Number (for SMS)
      </label>
      <input
        type="tel"
        id="phone_number"
        name="phone_number"
        value={preferences?.phone_number ?? ''}
        placeholder="+1234567890"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <p class="mt-1 text-sm text-gray-500">Include country code (e.g., +1 for US)</p>
    </div>

    <!-- Notification Types -->
    <div>
      <h3 class="text-lg font-medium text-gray-700 mb-4">Notification Types</h3>
      <div class="space-y-3">
        <label class="flex items-center">
          <input
            type="checkbox"
            name="outage_notifications"
            checked={preferences?.outage_notifications ?? true}
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
          />
          <span class="ml-2 text-gray-700">Service Outages</span>
        </label>
        
        <label class="flex items-center">
          <input
            type="checkbox"
            name="maintenance_notifications"
            checked={preferences?.maintenance_notifications ?? true}
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
          />
          <span class="ml-2 text-gray-700">Scheduled Maintenance</span>
        </label>
        
        <label class="flex items-center">
          <input
            type="checkbox"
            name="billing_notifications"
            checked={preferences?.billing_notifications ?? true}
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
          />
          <span class="ml-2 text-gray-700">Billing and Payments</span>
        </label>
        
        <label class="flex items-center">
          <input
            type="checkbox"
            name="marketing_notifications"
            checked={preferences?.marketing_notifications ?? false}
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
          />
          <span class="ml-2 text-gray-700">Marketing and Updates</span>
        </label>
      </div>
    </div>

    <!-- Severity Settings -->
    <div>
      <label for="minimum_severity" class="block text-sm font-medium text-gray-700 mb-2">
        Minimum Outage Severity
      </label>
      <select
        id="minimum_severity"
        name="minimum_severity"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        <option value="low" selected={preferences?.minimum_severity === 'low'}>
          Low - All outages
        </option>
        <option value="medium" selected={preferences?.minimum_severity === 'medium'}>
          Medium - Medium and above
        </option>
        <option value="high" selected={preferences?.minimum_severity === 'high'}>
          High - High and critical only
        </option>
        <option value="critical" selected={preferences?.minimum_severity === 'critical'}>
          Critical - Critical outages only
        </option>
      </select>
      <p class="mt-1 text-sm text-gray-500">
        Only receive notifications for outages at or above this severity level
      </p>
    </div>

    <!-- Quiet Hours -->
    <div>
      <h3 class="text-lg font-medium text-gray-700 mb-4">Quiet Hours</h3>
      <p class="text-sm text-gray-600 mb-3">
        Don't send non-critical notifications during these hours
      </p>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="quiet_hours_start" class="block text-sm font-medium text-gray-700 mb-2">
            Start Time
          </label>
          <input
            type="time"
            id="quiet_hours_start"
            name="quiet_hours_start"
            value={preferences?.quiet_hours_start ?? ''}
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label for="quiet_hours_end" class="block text-sm font-medium text-gray-700 mb-2">
            End Time
          </label>
          <input
            type="time"
            id="quiet_hours_end"
            name="quiet_hours_end"
            value={preferences?.quiet_hours_end ?? ''}
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
      </div>
    </div>

    <!-- Timezone -->
    <div>
      <label for="timezone" class="block text-sm font-medium text-gray-700 mb-2">
        Timezone
      </label>
      <select
        id="timezone"
        name="timezone"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        <option value="UTC" selected={preferences?.timezone === 'UTC'}>
          UTC
        </option>
        <option value="America/New_York" selected={preferences?.timezone === 'America/New_York'}>
          Eastern Time (ET)
        </option>
        <option value="America/Chicago" selected={preferences?.timezone === 'America/Chicago'}>
          Central Time (CT)
        </option>
        <option value="America/Denver" selected={preferences?.timezone === 'America/Denver'}>
          Mountain Time (MT)
        </option>
        <option value="America/Los_Angeles" selected={preferences?.timezone === 'America/Los_Angeles'}>
          Pacific Time (PT)
        </option>
        <option value="Asia/Jakarta" selected={preferences?.timezone === 'Asia/Jakarta'}>
          Western Indonesia Time (WIB)
        </option>
        <option value="Asia/Makassar" selected={preferences?.timezone === 'Asia/Makassar'}>
          Central Indonesia Time (WITA)
        </option>
        <option value="Asia/Jayapura" selected={preferences?.timezone === 'Asia/Jayapura'}>
          Eastern Indonesia Time (WIT)
        </option>
      </select>
    </div>

    <!-- Save Button -->
    <div class="flex justify-end">
      <button
        type="submit"
        class="px-6 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
      >
        Save Preferences
      </button>
    </div>
  </form>

  <!-- Success Message -->
  <div id="success-message" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
    <p class="text-green-800">Notification preferences saved successfully!</p>
  </div>

  <!-- Error Message -->
  <div id="error-message" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
    <p class="text-red-800">Failed to save notification preferences. Please try again.</p>
  </div>
</div>

<script>
  // Show/hide phone number field based on SMS checkbox
  document.querySelector('input[name="sms_notifications"]')?.addEventListener('change', function() {
    const phoneField = document.getElementById('phone-number-field');
    if (this.checked) {
      phoneField.classList.remove('hidden');
    } else {
      phoneField.classList.add('hidden');
    }
  });

  // Handle form submission
  document.getElementById('notification-preferences-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const preferences: Record<string, any> = {};
    
    // Convert form data to preferences object
    for (const [key, value] of formData.entries()) {
      if (key.endsWith('_notifications') || key === 'marketing_notifications') {
        preferences[key] = value === 'on';
      } else {
        preferences[key] = value;
      }
    }
    
    try {
      const response = await fetch('/api/notifications/preferences', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('supabase_token')}`,
        },
        body: JSON.stringify(preferences),
      });
      
      if (response.ok) {
        // Show success message
        document.getElementById('success-message')?.classList.remove('hidden');
        document.getElementById('error-message')?.classList.add('hidden');
        
        // Hide success message after 3 seconds
        setTimeout(() => {
          document.getElementById('success-message')?.classList.add('hidden');
        }, 3000);
      } else {
        throw new Error('Failed to save preferences');
      }
    } catch (error) {
      console.error('Error saving notification preferences:', {
        error: error instanceof Error ? error.message : String(error),
        timestamp: new Date().toISOString(),
        action: 'saveNotificationPreferences',
      });
      
      // Show error message
      document.getElementById('error-message')?.classList.remove('hidden');
      document.getElementById('success-message')?.classList.add('hidden');
      
      // Hide error message after 5 seconds
      setTimeout(() => {
        document.getElementById('error-message')?.classList.add('hidden');
      }, 5000);
    }
  });
</script>