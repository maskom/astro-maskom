---
import Layout from '../layouts/Layout.astro';
import { getStatusData } from '../lib/status';

interface ServiceStatus {
  id: string;
  name: string;
  status: 'operational' | 'degraded' | 'outage';
  description: string;
  updated_at: string;
}

interface Incident {
  id: string;
  title: string;
  status: 'investigating' | 'identified' | 'monitoring' | 'resolved';
  created_at: string;
  updated_at: string;
  description: string;
}

interface StatusData {
  overall_status: 'operational' | 'degraded' | 'outage';
  last_updated: string;
  services: ServiceStatus[];
  incidents: Incident[];
}

// Fetch real data from Supabase
const statusData: StatusData = await getStatusData();

// Calculate uptime percentage (mock data for now)
const uptimePercentage = 99.9;
---

<Layout title="Network Status">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Network Status</h1>

    <!-- Overall Status -->
    <div class="bg-gray-800 rounded-lg p-6 mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold mb-2">Overall System Status</h2>
          <p class="text-gray-300">
            All systems operational as of <span
              id="last-updated"
              class="font-mono"
              >{new Date(statusData.last_updated).toLocaleString()}</span
            >
          </p>
        </div>
        <div class="flex items-center">
          <div
            id="overall-status-indicator"
            class={`w-4 h-4 rounded-full mr-2 ${
              statusData.overall_status === 'operational'
                ? 'bg-green-500'
                : statusData.overall_status === 'degraded'
                  ? 'bg-yellow-500'
                  : 'bg-red-500'
            }`}
          >
          </div>
          <span id="overall-status-text" class="font-medium">
            {
              statusData.overall_status === 'operational'
                ? 'Operational'
                : statusData.overall_status === 'degraded'
                  ? 'Degraded'
                  : 'Outage'
            }
          </span>
        </div>
      </div>

      <!-- Uptime Stats -->
      <div class="mt-4 pt-4 border-t border-gray-700">
        <h3 class="font-medium mb-2">Uptime (Last 30 Days)</h3>
        <div class="flex items-end h-8">
          <div
            class="bg-green-500 h-full rounded"
            style={`width: ${uptimePercentage}%`}
          >
          </div>
          <span class="ml-2 text-sm">{uptimePercentage}%</span>
        </div>
      </div>
    </div>

    <!-- Services Status -->
    <div class="mb-8">
      <h2 class="text-2xl font-semibold mb-4">Services</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {
          statusData.services.map(service => (
            <div class="bg-gray-800 rounded-lg p-4">
              <div class="flex justify-between items-start">
                <h3 class="font-medium">{service.name}</h3>
                <div
                  class={`w-3 h-3 rounded-full ${
                    service.status === 'operational'
                      ? 'bg-green-500'
                      : service.status === 'degraded'
                        ? 'bg-yellow-500'
                        : 'bg-red-500'
                  }`}
                />
              </div>
              <p class="text-sm text-gray-400 mt-2">{service.description}</p>
              <p class="text-xs mt-3">
                {service.status === 'operational'
                  ? 'Operational'
                  : service.status === 'degraded'
                    ? 'Degraded Performance'
                    : 'Service Outage'}
              </p>
            </div>
          ))
        }
      </div>
    </div>

    <!-- Incidents -->
    <div>
      <h2 class="text-2xl font-semibold mb-4">Incidents</h2>
      {
        statusData.incidents.length > 0 ? (
          <div class="space-y-4">
            {statusData.incidents.map(incident => (
              <div class="bg-gray-800 rounded-lg p-4">
                <div class="flex justify-between items-start">
                  <h3 class="font-medium">{incident.title}</h3>
                  <span class="text-xs px-2 py-1 rounded bg-gray-700">
                    {incident.status === 'investigating'
                      ? 'Investigating'
                      : incident.status === 'identified'
                        ? 'Identified'
                        : incident.status === 'monitoring'
                          ? 'Monitoring'
                          : 'Resolved'}
                  </span>
                </div>
                <p class="text-sm text-gray-300 mt-2">{incident.description}</p>
                <p class="text-xs text-gray-500 mt-3">
                  Updated: {new Date(incident.updated_at).toLocaleString()}
                </p>
              </div>
            ))}
          </div>
        ) : (
          <div class="bg-gray-800 rounded-lg p-8 text-center">
            <p class="text-gray-400">No incidents reported.</p>
          </div>
        )
      }
    </div>
  </div>
</Layout>

<script>
  // Add real-time updates with polling
  let pollingInterval;

  const fetchStatusData = async () => {
    try {
      const response = await fetch('/api/status');
      const data = await response.json();

      // Update overall status
      const statusIndicator = document.getElementById(
        'overall-status-indicator'
      );
      const statusText = document.getElementById('overall-status-text');
      if (statusIndicator && statusText) {
        statusIndicator.className = `w-4 h-4 rounded-full mr-2 ${
          data.overall_status === 'operational'
            ? 'bg-green-500'
            : data.overall_status === 'degraded'
              ? 'bg-yellow-500'
              : 'bg-red-500'
        }`;
        statusText.textContent =
          data.overall_status === 'operational'
            ? 'Operational'
            : data.overall_status === 'degraded'
              ? 'Degraded'
              : 'Outage';
      }

      // Update last updated time
      const lastUpdatedElement = document.getElementById('last-updated');
      if (lastUpdatedElement) {
        lastUpdatedElement.textContent = new Date(
          data.last_updated
        ).toLocaleString();
      }

      // Update services
      // This would require more complex DOM manipulation in a real implementation
    } catch (error) {
      console.error('Error fetching status data:', error);
    }
  };

  // Start polling when page loads
  pollingInterval = setInterval(fetchStatusData, 60000); // Update every 60 seconds

  // Clean up interval when page unloads
  window.addEventListener('beforeunload', () => {
    if (pollingInterval) {
      clearInterval(pollingInterval);
    }
  });
</script>
