---
import Layout from '../../layouts/Layout.astro';

// This would normally be protected by admin middleware
// For now, we'll assume the user has admin privileges
---

<Layout title="Admin - Bandwidth Monitoring">
  <div class="max-w-7xl mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-gray-900">
        Admin - Bandwidth Monitoring
      </h1>
      <div class="flex space-x-3">
        <button
          class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
          onclick="refreshData()"
        >
          Refresh Data
        </button>
        <a
          href="/dashboard"
          class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
        >
          Back to Dashboard
        </a>
      </div>
    </div>

    <!-- Statistics Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="text-sm text-gray-600 mb-1">Total Users</div>
        <div class="text-2xl font-bold text-gray-900" id="totalUsers">-</div>
        <div class="text-xs text-gray-500">Active customers</div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="text-sm text-gray-600 mb-1">System Load</div>
        <div class="text-2xl font-bold text-blue-600" id="systemLoad">-</div>
        <div class="text-xs text-gray-500">Overall usage</div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="text-sm text-gray-600 mb-1">High Usage Users</div>
        <div class="text-2xl font-bold text-orange-600" id="highUsageUsers">
          -
        </div>
        <div class="text-xs text-gray-500">> 90% usage</div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="text-sm text-gray-600 mb-1">Avg Usage</div>
        <div class="text-2xl font-bold text-green-600" id="avgUsage">-</div>
        <div class="text-xs text-gray-500">Per user</div>
      </div>
    </div>

    <!-- High Usage Alerts -->
    <div
      class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 hidden"
      id="highUsageAlert"
    >
      <div class="flex items-center">
        <div class="text-2xl mr-3">‚ö†Ô∏è</div>
        <div>
          <h3 class="font-medium text-red-800">High Usage Alert</h3>
          <p class="text-sm text-red-600" id="highUsageAlertText">
            Some users are approaching their data caps.
          </p>
        </div>
      </div>
    </div>

    <!-- User Data Caps Table -->
    <div class="bg-white rounded-lg shadow-lg mb-6">
      <div class="p-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-semibold text-gray-800">User Data Caps</h2>
          <div class="flex space-x-3">
            <input
              type="text"
              placeholder="Search users..."
              class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              id="searchInput"
              onkeyup="searchUsers()"
            />
            <button
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              onclick="showAddUserModal()"
            >
              Add User Cap
            </button>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >User</th
              >
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >Package</th
              >
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >Monthly Cap</th
              >
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >Current Usage</th
              >
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >Usage %</th
              >
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >Status</th
              >
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >Actions</th
              >
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="userTableBody">
            <tr>
              <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                Loading user data...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="p-4 border-t border-gray-200">
        <div class="flex justify-between items-center">
          <div class="text-sm text-gray-700">
            Showing <span id="showingStart">0</span> to <span id="showingEnd"
              >0</span
            > of <span id="totalRecords">0</span> results
          </div>
          <div class="flex space-x-2">
            <button
              class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50"
              id="prevPage"
              onclick="changePage(-1)"
              disabled
            >
              Previous
            </button>
            <span class="px-3 py-1" id="currentPage">1</span>
            <button
              class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50"
              id="nextPage"
              onclick="changePage(1)"
              disabled
            >
              Next
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Notifications -->
    <div class="bg-white rounded-lg shadow-lg">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-800">
          Recent Notifications
        </h2>
      </div>
      <div class="p-6">
        <div id="notificationsList" class="space-y-3">
          <div class="text-center text-gray-500">Loading notifications...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add User Modal -->
  <div
    id="addUserModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
  >
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h3 class="text-lg font-semibold mb-4">Add User Data Cap</h3>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >User Email</label
          >
          <input
            type="email"
            id="userEmail"
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="user@example.com"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Package ID</label
          >
          <select
            id="packageId"
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="home-a">Home Access - Paket A</option>
            <option value="home-b">Home Access - Paket B</option>
            <option value="home-c">Home Access - Paket C</option>
            <option value="soho-pro">SOHO - Pro</option>
            <option value="soho-business">SOHO - Business</option>
            <option value="soho-enterprise">SOHO - Enterprise</option>
            <option value="corporate-business">Corporate - Business</option>
            <option value="corporate-enterprise">Corporate - Enterprise</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Monthly Cap (GB)</label
          >
          <input
            type="number"
            id="monthlyCap"
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="100"
            min="1"
          />
        </div>
      </div>

      <div class="flex space-x-3 mt-6">
        <button
          class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors"
          onclick="closeAddUserModal()"
        >
          Cancel
        </button>
        <button
          class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          onclick="addUserCap()"
        >
          Add User
        </button>
      </div>
    </div>
  </div>

  <script nonce={nonce}>
    let currentPage = 1;
    let totalPages = 1;
    let searchQuery = '';

    async function loadMonitoringData() {
      try {
        const token = localStorage.getItem('supabase_token');
        const response = await fetch(
          `/api/bandwidth/admin/monitoring?page=${currentPage}&limit=50&search=${searchQuery}`,
          {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          }
        );

        if (response.ok) {
          const data = await response.json();
          updateStatistics(data.statistics);
          updateUserTable(data.dataCaps);
          updatePagination(data.pagination);
          updateNotifications(data.recentNotifications);
          updateHighUsageAlert(data.highUsageUsers);
        } else {
          console.error('Failed to load monitoring data');
        }
      } catch (error) {
        console.error('Error loading monitoring data:', error);
      }
    }

    function updateStatistics(stats) {
      document.getElementById('totalUsers').textContent =
        stats.totalUsers.toLocaleString();
      document.getElementById('systemLoad').textContent =
        `${stats.systemLoadPercentage}%`;
      document.getElementById('highUsageUsers').textContent =
        stats.highUsageUsersCount.toLocaleString();
      document.getElementById('avgUsage').textContent =
        `${stats.averageUsagePercentage}%`;
    }

    function updateUserTable(dataCaps) {
      const tbody = document.getElementById('userTableBody');

      // Clear existing content
      tbody.innerHTML = '';

      if (dataCaps.length === 0) {
        const noUsersRow = document.createElement('tr');
        const noUsersCell = document.createElement('td');
        noUsersCell.colSpan = 7;
        noUsersCell.className = 'px-6 py-4 text-center text-gray-500';
        noUsersCell.textContent = 'No users found';
        noUsersRow.appendChild(noUsersCell);
        tbody.appendChild(noUsersRow);
        return;
      }

      dataCaps.forEach(cap => {
        const usagePercentage = (cap.current_usage_gb / cap.monthly_cap_gb) * 100;
        const statusColor = usagePercentage >= 90 ? 'red' : usagePercentage >= 80 ? 'yellow' : 'green';
        const statusText = usagePercentage >= 90 ? 'Critical' : usagePercentage >= 80 ? 'Warning' : 'Normal';

        const row = document.createElement('tr');

        // User cell
        const userCell = document.createElement('td');
        userCell.className = 'px-6 py-4 whitespace-nowrap';
        const userDiv = document.createElement('div');
        userDiv.className = 'text-sm font-medium text-gray-900';
        userDiv.textContent = cap.user?.email || 'Unknown';
        userCell.appendChild(userDiv);

        // Package cell
        const packageCell = document.createElement('td');
        packageCell.className = 'px-6 py-4 whitespace-nowrap';
        const packageDiv = document.createElement('div');
        packageDiv.className = 'text-sm text-gray-900';
        packageDiv.textContent = cap.package_id;
        packageCell.appendChild(packageDiv);

        // Monthly cap cell
        const monthlyCapCell = document.createElement('td');
        monthlyCapCell.className = 'px-6 py-4 whitespace-nowrap';
        const monthlyCapDiv = document.createElement('div');
        monthlyCapDiv.className = 'text-sm text-gray-900';
        monthlyCapDiv.textContent = `${cap.monthly_cap_gb} GB`;
        monthlyCapCell.appendChild(monthlyCapDiv);

        // Current usage cell
        const currentUsageCell = document.createElement('td');
        currentUsageCell.className = 'px-6 py-4 whitespace-nowrap';
        const currentUsageDiv = document.createElement('div');
        currentUsageDiv.className = 'text-sm text-gray-900';
        currentUsageDiv.textContent = `${cap.current_usage_gb.toFixed(2)} GB`;
        currentUsageCell.appendChild(currentUsageDiv);

        // Usage percentage cell
        const usagePercentCell = document.createElement('td');
        usagePercentCell.className = 'px-6 py-4 whitespace-nowrap';
        const usageFlexDiv = document.createElement('div');
        usageFlexDiv.className = 'flex items-center';
        
        const usagePercentDiv = document.createElement('div');
        usagePercentDiv.className = 'text-sm text-gray-900 mr-2';
        usagePercentDiv.textContent = `${usagePercentage.toFixed(1)}%`;
        
        const progressBarDiv = document.createElement('div');
        progressBarDiv.className = 'w-16 bg-gray-200 rounded-full h-2';
        
        const progressBarFill = document.createElement('div');
        progressBarFill.className = `bg-${statusColor}-500 h-2 rounded-full admin-usage-bar`;
        progressBarFill.style.setProperty('--admin-usage-width', `${Math.min(usagePercentage, 100)}%`);
        
        progressBarDiv.appendChild(progressBarFill);
        usageFlexDiv.appendChild(usagePercentDiv);
        usageFlexDiv.appendChild(progressBarDiv);
        usagePercentCell.appendChild(usageFlexDiv);

        // Status cell
        const statusCell = document.createElement('td');
        statusCell.className = 'px-6 py-4 whitespace-nowrap';
        const statusSpan = document.createElement('span');
        statusSpan.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${statusColor}-100 text-${statusColor}-800`;
        statusSpan.textContent = statusText;
        statusCell.appendChild(statusSpan);

        // Actions cell
        const actionsCell = document.createElement('td');
        actionsCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium';
        
        const viewButton = document.createElement('button');
        viewButton.className = 'text-indigo-600 hover:text-indigo-900 mr-3';
        viewButton.textContent = 'View';
        viewButton.onclick = () => viewUserDetails(cap.user_id);
        
        const editButton = document.createElement('button');
        editButton.className = 'text-blue-600 hover:text-blue-900';
        editButton.textContent = 'Edit';
        editButton.onclick = () => editUserCap(cap.id);
        
        actionsCell.appendChild(viewButton);
        actionsCell.appendChild(editButton);

        row.appendChild(userCell);
        row.appendChild(packageCell);
        row.appendChild(monthlyCapCell);
        row.appendChild(currentUsageCell);
        row.appendChild(usagePercentCell);
        row.appendChild(statusCell);
        row.appendChild(actionsCell);

        tbody.appendChild(row);
      });
    }

    function updatePagination(pagination) {
      currentPage = pagination.page;
      totalPages = pagination.totalPages;

      document.getElementById('showingStart').textContent =
        (currentPage - 1) * pagination.limit + 1;
      document.getElementById('showingEnd').textContent = Math.min(
        currentPage * pagination.limit,
        pagination.total
      );
      document.getElementById('totalRecords').textContent = pagination.total;
      document.getElementById('currentPage').textContent = currentPage;

      document.getElementById('prevPage').disabled = currentPage <= 1;
      document.getElementById('nextPage').disabled = currentPage >= totalPages;
    }

    function updateNotifications(notifications) {
      const container = document.getElementById('notificationsList');

      // Clear existing content
      container.innerHTML = '';

      if (notifications.length === 0) {
        const noNotificationsDiv = document.createElement('div');
        noNotificationsDiv.className = 'text-center text-gray-500';
        noNotificationsDiv.textContent = 'No recent notifications';
        container.appendChild(noNotificationsDiv);
        return;
      }

      notifications.slice(0, 10).forEach(notif => {
        const notifDiv = document.createElement('div');
        notifDiv.className = 'flex items-start space-x-3 p-3 bg-gray-50 rounded-lg';

        const emojiDiv = document.createElement('div');
        emojiDiv.className = 'text-2xl';
        emojiDiv.textContent = notif.threshold_percentage >= 90 ? 'üî¥' : notif.threshold_percentage >= 80 ? 'üü°' : 'üîµ';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'flex-1';

        const emailDiv = document.createElement('div');
        emailDiv.className = 'text-sm font-medium text-gray-900';
        emailDiv.textContent = notif.user?.email || 'Unknown User';

        const messageDiv = document.createElement('div');
        messageDiv.className = 'text-sm text-gray-600';
        messageDiv.textContent = notif.message;

        const timeDiv = document.createElement('div');
        timeDiv.className = 'text-xs text-gray-500 mt-1';
        timeDiv.textContent = new Date(notif.sent_at).toLocaleString();

        contentDiv.appendChild(emailDiv);
        contentDiv.appendChild(messageDiv);
        contentDiv.appendChild(timeDiv);

        notifDiv.appendChild(emojiDiv);
        notifDiv.appendChild(contentDiv);

        container.appendChild(notifDiv);
      });
    }

    function updateHighUsageAlert(highUsageUsers) {
      const alertDiv = document.getElementById('highUsageAlert');
      const alertText = document.getElementById('highUsageAlertText');

      if (highUsageUsers.length > 0) {
        alertDiv.classList.remove('hidden');
        alertText.textContent = `${highUsageUsers.length} user(s) are using more than 90% of their data cap.`;
      } else {
        alertDiv.classList.add('hidden');
      }
    }

    function changePage(direction) {
      currentPage += direction;
      loadMonitoringData();
    }

    function searchUsers() {
      searchQuery = document.getElementById('searchInput').value;
      currentPage = 1;
      loadMonitoringData();
    }

    function refreshData() {
      loadMonitoringData();
    }

    function showAddUserModal() {
      document.getElementById('addUserModal').classList.remove('hidden');
      document.getElementById('addUserModal').classList.add('flex');
    }

    function closeAddUserModal() {
      document.getElementById('addUserModal').classList.add('hidden');
      document.getElementById('addUserModal').classList.remove('flex');
      // Clear form
      document.getElementById('userEmail').value = '';
      document.getElementById('packageId').selectedIndex = 0;
      document.getElementById('monthlyCap').value = '';
    }

    async function addUserCap() {
      const email = document.getElementById('userEmail').value;
      const packageId = document.getElementById('packageId').value;
      const monthlyCap = document.getElementById('monthlyCap').value;

      if (!email || !monthlyCap) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const token = localStorage.getItem('supabase_token');
        const response = await fetch('/api/bandwidth/admin/monitoring', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            userId: email, // This would need to be converted to actual user ID
            package_id: packageId,
            monthly_cap_gb: parseInt(monthlyCap),
          }),
        });

        if (response.ok) {
          alert('User data cap added successfully!');
          closeAddUserModal();
          loadMonitoringData();
        } else {
          const error = await response.json();
          alert('Failed to add user cap: ' + error.error);
        }
      } catch (error) {
        console.error('Error adding user cap:', error);
        alert('An error occurred while adding user cap');
      }
    }

    function viewUserDetails(userId) {
      // Implementation for viewing user details
      console.log('View user details:', userId);
    }

    function editUserCap(capId) {
      // Implementation for editing user cap
      console.log('Edit user cap:', capId);
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadMonitoringData);
  </script>
</Layout>

<style>
  .admin-usage-bar {
    width: var(--admin-usage-width, 0%);
  }
</style>
