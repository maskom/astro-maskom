name: "ðŸ¤– Otomatisasi iFlow CLI"

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, reopened, synchronize]
  pull_request_review_comment:
    types: [created]
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Optional: issue number to triage or implement'
        required: false
        type: number
      pr_number:
        description: 'Optional: pull request number to review or apply changes'
        required: false
        type: number

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

jobs:
  klasifikasi_isu:
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@iflow-cli /triage')) ||
      (github.event_name == 'workflow_dispatch' && inputs.issue_number)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - name: "Jalankan iFlow CLI untuk Klasifikasi Isu dan Implementasi"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title || 'manual' }}
          ISSUE_BODY: ${{ github.event.issue.body || '' }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
           prompt: |
             ## Peran
             Anda adalah pengembang AI dan manajer proyek yang bertanggung jawab atas klasifikasi isu dan implementasi fitur atau perbaikan bug.

             ## Tugas
             - Beri label, implementasikan, dan buka PR jika diperlukan.

  tinjau_pr:
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@iflow-cli /review')) ||
      (github.event_name == 'workflow_dispatch' && inputs.pr_number)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Jalankan iFlow CLI untuk Tinjauan Pull Request"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
          BASE_REF: ${{ github.event.pull_request.base.ref || 'main' }}
          HEAD_REF: ${{ github.event.pull_request.head.ref || '' }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
           prompt: |
             ## Peran
             Anda adalah peninjau kode AI.

             ## Tugas
             - Periksa PR dan tinjau perbedaan.
             - Posting komentar umpan balik terstruktur.

  terapkan_perubahan_pr:
    if: github.event_name == 'pull_request_review_comment'
    runs-on: ubuntu-latest
    concurrency:
      group: apply-${{ github.event.pull_request.number }}-${{ github.event.comment.id }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Jalankan iFlow CLI untuk Menerapkan Perubahan Tinjauan (Semua Komentar dalam Percakapan)"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMENT_ID: ${{ github.event.comment.id }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
           prompt: |
             ## Peran
             Anda adalah pemelihara AI otonom.

             ## Konteks
             - PR: `${{ env.PR_NUMBER }}`
             - ID Komentar: `${{ env.COMMENT_ID }}`
             - Repositori: `${{ env.REPOSITORY }}`

             ## Langkah-langkah
             1. Identifikasi utas percakapan dari komentar:
                `thread_id=$(gh api repos/${{ env.REPOSITORY }}/pulls/comments/${{ env.COMMENT_ID }} --jq '.in_reply_to_id // .id')`
             2. Ambil semua komentar dalam percakapan tersebut:
                `gh api repos/${{ env.REPOSITORY }}/pulls/${{ env.PR_NUMBER }}/comments --paginate --jq ".[] | select(.in_reply_to_id == $thread_id or .id == $thread_id)" > conversation.json`
             3. Analisis `conversation.json` untuk mengumpulkan semua instruksi teknis.
             4. Periksa cabang PR: `gh pr checkout $PR_NUMBER`.
             5. Terapkan semua perubahan yang dapat dilakukan dari utas komentar lengkap.
             6. Jalankan pemeriksaan cepat (lint/tes).
             7. Jika valid:
                `git commit -am "Terapkan saran tinjauan dari percakapan ${thread_id}" && git push`.
             8. Komentar konfirmasi:
                `gh pr comment $PR_NUMBER --body "Telah menerapkan semua saran yang dapat dilakukan dari percakapan ini."`

             ## Aturan
             - Hanya terapkan edit lokal yang tepat dan aman.
             - Abaikan umpan balik yang abstrak atau tidak jelas.
             - Jangan gabungkan PR.
             - Pertahankan komit atomik dan aman untuk konkurensi.

  pemeliharaan:
    if: github.event_name == 'schedule'  
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: "Jalankan iFlow CLI untuk Pemeliharaan Repositori"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '10800'
           prompt: |
             ## Peran
             Anda adalah pemelihara AI yang memastikan kesehatan dan keamanan jangka panjang.

             ## Tugas
             - Pindai, refaktor, perbarui dependensi dengan aman.
             - Komit ke `iflow/maintenance/${{ github.run_id }}` dan buka PR.
